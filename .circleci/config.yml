jobs:
  build_android:
    docker:
      - image: circleci/android:api-28-node
    resource_class: medium
    environment:
      TOTAL_CPUS: 2 # For class docker medium
    shell: /bin/bash -eo pipefail
    steps:
      - run:
          name: "Show current CPU count"
          command: |
            echo "CPU count is ${TOTAL_CPUS}"
      - add_ssh_keys: # Install
          fingerprints:
            - "9a:0f:b1:f0:97:c8:db:3f:be:87:a4:9b:09:7f:d3:af"
      - checkout
      - run:
          name: "Pull Submodules"
          command: |
            git submodule init
            git submodule update --remote
      - restore_cache:
          keys:
            - 1-gems-{{ arch }}-{{ checksum "android/Gemfile.lock" }}
            - 1-gems-{{ arch }}-
      - run:
          command: bundle check || bundle install --path vendor/bundle
          working_directory: android
      - save_cache:
          key: 1-gems-{{ arch }}-{{ checksum "android/Gemfile.lock" }}
          paths:
            - android/vendor/bundle
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
            - 2-yarn-{{ arch }}-
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
            - node_modules
      - run:
          name: Linting check
          command: yarn run lint
      - run:
          name: Flow-type check
          command: yarn run flow:check-now
      - run:
          name: Unit tests
          command: yarn run test --maxWorkers 2
      - run:
          name: Ruby version
          command: ruby --version
      - run:
          name: Fastlane Prepare Android Keystore
          command: bundle exec fastlane keystore
          working_directory: android
      - restore_cache:
          keys:
            - 1-gradle-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}-{{ checksum "android/settings.gradle" }}
            - 1-gradle-
      - run:
          name: Download Dependencies
          command: bundle exec fastlane dependencies
          working_directory: android
      - save_cache:
          paths:
            - ~/.gradle
          key: 1-gradle-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}-{{ checksum "android/settings.gradle" }}
      - run:
          name: Fastlane Release Build
          command: bundle exec fastlane release
          working_directory: android
      - store_artifacts:
          path: android/app/build/outputs/apk/release/
      - persist_to_workspace:
          root: android/app/build/generated/sourcemaps/react/release/
          paths:
            - index.android.bundle.map
      - persist_to_workspace:
          root: android/app/build/outputs/apk/release/
          paths:
            - app-release.apk

  build_ios:
    macos:
      xcode: 11.2.0
    environment:
      FL_OUTPUT_DIR: output
      FASTLANE_SKIP_UPDATE_CHECK: true
      TOTAL_CPUS: 4 # For class mac medium
    shell: /bin/bash --login -o pipefail
    steps:
      - run:
          name: "Show current CPU count"
          command: |
            echo "CPU count is ${TOTAL_CPUS}"
      - add_ssh_keys:
          fingerprints:
            - "9a:0f:b1:f0:97:c8:db:3f:be:87:a4:9b:09:7f:d3:af"
      - checkout
      - run:
          name: "Pull Submodules"
          command: |
            git submodule init
            git submodule update --remote
      - restore_cache:
          keys:
            - 1-gems-{{ arch }}-{{ checksum "ios/Gemfile.lock" }}
            - 1-gems-{{ arch }}-
      - run:
          command: bundle check || bundle install --path vendor/bundle
          working_directory: ios
      - save_cache:
          key: 1-gems-{{ arch }}-{{ checksum "ios/Gemfile.lock" }}
          paths:
            - ios/vendor/bundle
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - 4-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
            - 4-yarn-{{ arch }}-
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 4-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/Library/Caches/Yarn/
            - node_modules
      - restore_cache:
          name: Restore CocoaPods Cache
          keys:
            - 1-pods-{{ arch }}-{{ checksum "ios/Podfile.lock" }}
            - 1-pods-{{ arch }}-
      - run:
          name: Install CocoaPods
          command: bundle exec pod install --deployment
          working_directory: ios
      - save_cache:
          name: Save CocoaPods Cache
          key: 1-pods-{{ arch }}-{{ checksum "ios/Podfile.lock" }}
          paths:
            - ~/Library/Caches/CocoaPods/
      - run:
          name: Ruby version
          command: ruby --version
      - run:
          name: Fastlane Release Build
          command: bundle exec fastlane release
          working_directory: ios
      - run:
          name: Fastlane TestFlight Upload
          command: bundle exec fastlane testflight_upload
          working_directory: ios
      - store_artifacts:
          path: ios/output/gym/
      - persist_to_workspace:
          root: ios/
          paths:
            - index.ios.bundle.map
      - persist_to_workspace:
          root: ios/output/gym/
          paths:
            - Integreat.ipa

  deliver_android:
    docker:
      - image: circleci/android:api-28-node
    resource_class: small
    shell: /bin/bash -eo pipefail
    steps:
      - run: 'curl -sL https://sentry.io/get-cli/ | bash'
      - checkout
      - attach_workspace:
          at: /tmp/output
      - restore_cache:
          keys:
            - 1-gems-{{ arch }}-{{ checksum "Gemfile.lock" }}
            - 1-gems-{{ arch }}-
      - run:
          command: bundle check || bundle install --path vendor/bundle
      - save_cache:
          key: 1-gems-{{ arch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
            - node_modules
      - run:
          name: Fastlane Browserstack Upload Live
          command: bundle exec fastlane android browserstack_upload_live
      - run:
          name: Fastlane E2E Tests on Browserstack
          command: bundle exec fastlane android browserstack_e2e_tests
      - run:
          name: Fastlane Play Store Upload
          command: bundle exec fastlane android playstore_upload
      - run:
          name: Fastlane Upload to Sentry
          command: bundle exec fastlane android sentry_upload
      - run:
          name: Bump version
          command: bundle exec fastlane github_bump_version

  e2e_ios:
    docker:
      - image: circleci/android:api-28-node
    resource_class: small
    shell: /bin/bash -eo pipefail
    steps:
      - run: 'curl -sL https://sentry.io/get-cli/ | bash'
      - checkout
      - attach_workspace:
          at: /tmp/output
      - restore_cache:
          keys:
            - 1-gems-{{ arch }}-{{ checksum "Gemfile.lock" }}
            - 1-gems-{{ arch }}-
      - run:
          command: bundle check || bundle install --path vendor/bundle
      - save_cache:
          key: 1-gems-{{ arch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
            - node_modules
      - run:
          name: Fastlane Browserstack Upload Live
          command: bundle exec fastlane ios browserstack_upload_live
      - run:
          name: Fastlane E2E Tests on Browserstack
          command: bundle exec fastlane ios browserstack_e2e_tests
      - run:
          name: Fastlane Upload to Sentry
          command: bundle exec fastlane ios sentry_upload

version: 2.1

workflows:
  version: 2
  commit:
    jobs:
      - build_android
      - build_ios
      - deliver_android:
          requires:
            - build_android
      - e2e_ios:
          requires:
            - build_ios
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - NATIVE-487-cd # FIXME: Change
    jobs:
      - build_android
      - build_ios
      - deliver_android:
          requires:
            - build_android
      - e2e_ios:
          requires:
            - build_ios
