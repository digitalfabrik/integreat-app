jobs:
  build_android:
    docker:
      - image: circleci/android:api-28-node
    resource_class: medium+
    environment:
      GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m -XX:+HeapDumpOnOutOfMemoryError -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.configureondemand=true"
      BUNDLE_CONFIG: ./metro.config.ci.js
    steps:
      - add_ssh_keys:
          fingerprints:
            - "9a:0f:b1:f0:97:c8:db:3f:be:87:a4:9b:09:7f:d3:af"
      - checkout
      - restore_cache:
          key: 1-gems-{{ checksum "android/Gemfile.lock" }}-{{ arch }}
      - run:
          command: bundle check || bundle install --path vendor/bundle
          working_directory: android
      - save_cache:
          key: 1-gems-{{ checksum "android/Gemfile.lock" }}-{{ arch }}
          paths:
            - android/vendor/bundle
      - run:
          name: "Pull Submodules"
          command: |
            git submodule init
            git submodule update --remote
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - 1-yarn-v1-{{ checksum "yarn.lock" }}-{{ arch }}
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 1-yarn-v1-{{ checksum "yarn.lock" }}-{{ arch }}
          paths:
            - ~/.cache/yarn
      - run:
          name: Ruby version
          command: ruby --version
      - run:
          name: fastlane
          command: bundle exec fastlane android keystore
          working_directory: android
      - restore_cache:
          key: gradle-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}-{{ checksum "android/settings.gradle" }}
      - run:
          name: Download Dependencies
          command: bundle exec fastlane android dependencies
          working_directory: android
      - save_cache:
          paths:
            - ~/.gradle
          key: gradle-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}-{{ checksum "android/settings.gradle" }}
      - run:
          name: Fastlane Release Build
          command: bundle exec fastlane android build
          working_directory: android
      - run:
          name: Fastlane Browserstack Upload Live
          command: bundle exec fastlane android browserstack_upload_live
          working_directory: android
      - run:
          name: Fastlane Browserstack Upload Automate
          command: |
            bundle exec fastlane android browserstack_upload_auto
            echo "export BROWSERSTACK_APP_ID=$BROWSERSTACK_APP_ID" >> $BASH_ENV
          working_directory: android
      - run:
          name: Run E2E tests
          environment:
            E2E_CAPS: ci_browserstack
            E2E_PLATFORM: android
            E2E_SERVER: browserstack
          command: |
            export E2E_BROWSERSTACK_USER=$BROWSERSTACK_USERNAME
            export E2E_BROWSERSTACK_KEY=$BROWSERSTACK_ACCESS_KEY
            export E2E_BROWSERSTACK_APP=$BROWSERSTACK_APP_ID
            yarn test:e2e
      - run:
          name: Fastlane Play Store Upload
          command: bundle exec fastlane android playstore_upload
          working_directory: android
      - store_artifacts:
          path: android/app/build/outputs/apk

  build_ios:
    macos:
      xcode: 11.2.0
    environment:
      FL_OUTPUT_DIR: output
      FASTLANE_LANE: ios
    shell: /bin/bash --login -o pipefail
    steps:
      - add_ssh_keys:
          fingerprints:
            - "9a:0f:b1:f0:97:c8:db:3f:be:87:a4:9b:09:7f:d3:af"
      - checkout
      - restore_cache:
          key: 1-gems-{{ checksum "ios/Gemfile.lock" }}-{{ arch }}
      - run:
          command: bundle check || bundle install --path vendor/bundle
          working_directory: ios
      - save_cache:
          key: 1-gems-{{ checksum "ios/Gemfile.lock" }}-{{ arch }}
          paths:
            - ios/vendor/bundle
      - run:
          name: "Pull Submodules"
          command: |
            git submodule init
            git submodule update --remote
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - 3-yarn-v1-{{ checksum "yarn.lock" }}-{{ arch }}
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 3-yarn-v1-{{ checksum "yarn.lock" }}-{{ arch }}
          paths:
            - ~/Library/Caches/Yarn/
      - run:
          name: Install CocoaPods
          command: pod install
          working_directory: ios
      - run:
          name: Ruby version
          command: ruby --version
      - run:
          name: Fastlane Release Build
          command: bundle exec fastlane ios release
          working_directory: ios
      - run:
          name: Fastlane Browserstack Upload Live
          command: bundle exec fastlane ios browserstack_upload_live
          working_directory: ios
      - run:
          name: Fastlane Browserstack Upload Automate
          command: |
            bundle exec fastlane ios browserstack_upload_auto
            echo "export BROWSERSTACK_APP_ID=$BROWSERSTACK_APP_ID" >> $BASH_ENV
          working_directory: ios
      - run:
          name: Run E2E tests
          environment:
            E2E_CAPS: ci_browserstack_ios
            E2E_PLATFORM: ios
            E2E_SERVER: browserstack
          command: |
            export E2E_BROWSERSTACK_USER=$BROWSERSTACK_USERNAME
            export E2E_BROWSERSTACK_KEY=$BROWSERSTACK_ACCESS_KEY
            export E2E_BROWSERSTACK_APP=$BROWSERSTACK_APP_ID
            yarn test:e2e
      - store_artifacts:
          path: ios/output


version: 2.1

workflows:
  react-native:
    jobs:
      - build_android
      - build_ios

