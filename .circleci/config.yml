version: 2.1

orbs:
  slack: circleci/slack@3.4.2

parameters:
  api_triggered:
    type: boolean
    description: Whether the pipeline was triggered through the CircleCi API (https://circleci.com/docs/api/v2/?shell#trigger-a-new-pipeline).
    default: false
  production_delivery:
    type: boolean
    description: Whether to deliver to production or not (beta channel and testflight).
    default: false

commands:
  restore_environment_variables:
    description: Sets the environment variables specified in the file 'environment_variables'. Make sure the file is persisted and has been attached.
    steps:
      - run:
          name: List environment variables
          command: cat environment_variables
      - run:
          name: Restore environment variables
          command: cat environment_variables >> ${BASH_ENV}

workflows:
  version: 2
  commit:
    unless: << pipeline.parameters.api_triggered >>
    jobs:
      - prepare_build
      - build_android:
          build_for_delivery: false
          requires:
            - prepare_build
      - build_ios:
          build_for_delivery: false
          requires:
            - prepare_build
      - e2e:
          requires:
            - build_ios
            - build_android

  api_triggered_delivery:
    when: << pipeline.parameters.api_triggered >>
    jobs:
      - prepare_build
      - build_android:
          build_for_delivery: true
          requires:
            - prepare_build
      - build_ios:
          build_for_delivery: true
          requires:
            - prepare_build
      - e2e:
          requires:
            - build_ios
            - build_android
      - bump_version:
          requires: # Bump version should only depend on build_ and not delivery_. Sometimes upload to the stores fails only for iOS or Android. Then we still should bump the version.
            - e2e
      - deliver_android:
          production_delivery: << pipeline.parameters.production_delivery >>
          requires:
            - bump_version
      - deliver_ios:
          production_delivery: << pipeline.parameters.production_delivery >>
          requires:
            - bump_version

  weekly_development_delivery:
    triggers:
      - schedule:
          cron: "0 3 * * 4" # For sanity checks for this syntax: https://crontab.guru/
          filters:
            branches:
              only:
                - develop
    jobs:
      - prepare_build
      - build_android:
          build_for_delivery: true
          requires:
            - prepare_build
      - build_ios:
          build_for_delivery: true
          requires:
            - prepare_build
      - e2e:
          requires:
            - build_ios
            - build_android
      - bump_version:
          requires: # Bump version should only depend on build_ and not delivery_. Sometimes upload to the stores fails only for iOS or Android. Then we still should bump the version.
            - e2e
      - deliver_android:
          production_delivery: false
          requires:
            - bump_version
      - deliver_ios:
          production_delivery: false
          requires:
            - bump_version

  bi_weekly_production_delivery:
    triggers:
      - schedule:
          cron: "0 5 1,15 * *" # For sanity checks for this syntax: https://crontab.guru/
          filters:
            branches:
              only:
                - develop
    jobs:
      - prepare_build
      - build_android:
          build_for_delivery: true
          requires:
            - prepare_build
      - build_ios:
          build_for_delivery: true
          requires:
            - prepare_build
      - e2e:
          requires:
            - build_ios
            - build_android
      - bump_version:
          requires: # Bump version should only depend on build_ and not delivery_. Sometimes upload to the stores fails only for iOS or Android. Then we should still bump the version.
            - e2e
      - await_production_approval:
          type: approval
          requires:
            - bump_version
      - deliver_android:
          production_delivery: true
          requires:
            - await_production_approval
      - deliver_ios:
          production_delivery: true
          requires:
            - await_production_approval

jobs:
  prepare_build:
    docker:
      - image: circleci/android:api-28-node
    resource_class: small
    environment:
      TOTAL_CPUS: 1 # For resource_class small
    shell: /bin/bash -eo pipefail
    steps:
      - checkout
      - restore_cache:
          name: Restore Yarn Package Cache
          keys: # Integer Prefix used for manually invalidating caches by incrementing.
            - 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
            - 2-yarn-{{ arch }}-
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
            - node_modules
      - run:
          name: Linting check
          command: yarn run lint
      - run:
          name: Flow-type check
          command: yarn run flow:check-now --max-workers ${TOTAL_CPUS}
      - run:
          name: Unit tests
          command: yarn run test --maxWorkers ${TOTAL_CPUS}
      - run:
          name: Calculate next version name
          command: echo "export NEW_VERSION_NAME=$(tools/next-version calc | jq .versionName)" >> environment_variables
      - run:
          name: Calculate next version code
          command: echo "export NEW_VERSION_CODE=$(tools/next-version calc | jq .versionCode)" >> environment_variables
      - persist_to_workspace:
          root: ./
          paths:
            - environment_variables

  build_android:
    parameters:
      build_for_delivery:
        description: Whether builds are delivered to the store. If true, integreat and malte builds are created.
        type: boolean
    docker:
      - image: circleci/android:api-28-node
    resource_class: medium
    environment:
      TOTAL_CPUS: 2 # For resource_class medium, used in metro.config.ci.js.
      FASTLANE_SKIP_UPDATE_CHECK: true
    shell: /bin/bash -eo pipefail
    steps:
      - add_ssh_keys:
          fingerprints:
            - "9a:0f:b1:f0:97:c8:db:3f:be:87:a4:9b:09:7f:d3:af"
      - checkout
      - attach_workspace:
          at: .
      - restore_environment_variables
      - restore_cache:
          keys:
            - 1-gems-{{ arch }}-{{ checksum "android/Gemfile.lock" }}
            - 1-gems-{{ arch }}-
      - run:
          command: bundle check || bundle install --path vendor/bundle
          working_directory: android
      - save_cache:
          key: 1-gems-{{ arch }}-{{ checksum "android/Gemfile.lock" }}
          paths:
            - android/vendor/bundle
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
            - 2-yarn-{{ arch }}-
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
            - node_modules
      - run:
          name: "[FL] Prepare Android Keystore"
          command: bundle exec fastlane keystore
          working_directory: android
      - restore_cache:
          keys:
            - 1-gradle-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}-{{ checksum "android/settings.gradle" }}
            - 1-gradle-
      - run:
          name: "[FL] Download Dependencies"
          command: bundle exec fastlane dependencies
          working_directory: android
      - save_cache:
          paths:
            - ~/.gradle
          key: 1-gradle-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}-{{ checksum "android/settings.gradle" }}
      - run:
          name: Create output dir
          command: mkdir --parents android/output/apk
      - when:
          condition: << parameters.build_for_delivery >>
          steps:
            - run:
                name: "[FL] integreat build"
                environment:
                  BUILD_CONFIG_NAME: integreat
                command: bundle exec fastlane build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
                working_directory: android
            - run:
                name: Rename apk
                command: mv android/app/build/outputs/apk/release/app-release.apk android/output/apk/integreat.apk
            - run:
                name: Rename sourcemap
                command: mv android/app/build/generated/sourcemaps/react/release/index.android.bundle.map android/output/integreat.android.bundle.map
            - run:
                name: "[FL] malte build"
                environment:
                  BUILD_CONFIG_NAME: malte
                command: bundle exec fastlane build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
                working_directory: android
            - run:
                name: Rename apk
                command: mv android/app/build/outputs/apk/release/app-release.apk android/output/apk/malte.apk
            - run:
                name: Rename sourcemap
                command: mv android/app/build/generated/sourcemaps/react/release/index.android.bundle.map android/output/malte.android.bundle.map
      - run:
          name: "[FL] integreat-test-cms build"
          environment:
            BUILD_CONFIG_NAME: integreat-test-cms
            E2E_TEST_IDS: 1
          command: bundle exec fastlane build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
          working_directory: android
      - run:
          name: Rename apk
          command: mv android/app/build/outputs/apk/release/app-release.apk android/output/apk/integreat-test-cms.apk
      - run:
          name: Rename sourcemap
          command: mv android/app/build/generated/sourcemaps/react/release/index.android.bundle.map android/output/integreat-test-cms.android.bundle.map
      - store_artifacts:
          path: android/output/apk
      - persist_to_workspace:
          root: android/output
          paths:
            - integreat.android.bundle.map
            - malte.android.bundle.map
            - integreat-test-cms.android.bundle.map
      - persist_to_workspace:
          root: android/output/apk
          paths:
            - integreat.apk
            - malte.apk
            - integreat-test-cms.apk

  build_ios:
    parameters:
      build_for_delivery:
        description: Whether builds are delivered to the store. If true, integreat and malte builds are created.
        type: boolean
    macos:
      xcode: 11.5.0
    environment:
      FL_OUTPUT_DIR: output
      FASTLANE_SKIP_UPDATE_CHECK: true
      TOTAL_CPUS: 4 # For mac with resource_class medium, used in metro.config.ci.js.
    shell: /bin/bash --login -o pipefail
    steps:
      - add_ssh_keys:
          fingerprints:
            - "9a:0f:b1:f0:97:c8:db:3f:be:87:a4:9b:09:7f:d3:af"
      - checkout
      - attach_workspace:
          at: .
      - restore_environment_variables
      - restore_cache:
          keys:
            - 1-gems-{{ arch }}-{{ checksum "ios/Gemfile.lock" }}
            - 1-gems-{{ arch }}-
      - run:
          command: bundle check || bundle install --path vendor/bundle
          working_directory: ios
      - save_cache:
          key: 1-gems-{{ arch }}-{{ checksum "ios/Gemfile.lock" }}
          paths:
            - ios/vendor/bundle
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - 4-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
            - 4-yarn-{{ arch }}-
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 4-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/Library/Caches/Yarn/
            - node_modules
      - restore_cache:
          name: Restore CocoaPods Cache
          keys:
            - 1-pods-{{ arch }}-{{ checksum "ios/Podfile.lock" }}
            - 1-pods-{{ arch }}-
      - run:
          name: "[CP] Install CocoaPods"
          command: bundle exec pod install --deployment
          working_directory: ios
      - save_cache:
          name: Save CocoaPods Cache
          key: 1-pods-{{ arch }}-{{ checksum "ios/Podfile.lock" }}
          paths:
            - ~/Library/Caches/CocoaPods/
      - when:
          condition: << parameters.build_for_delivery >>
          steps:
            - run:
                name: "[FL] integreat build"
                environment:
                  BUILD_CONFIG_NAME: integreat
                command: bundle exec fastlane build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE} scheme:${BUILD_CONFIG_NAME}
                working_directory: ios
            - run:
                name: Rename sourcemap
                command: mv ios/index.ios.bundle.map ios/output/integreat.ios.bundle.map
            - run:
                name: "[FL] malte build"
                environment:
                  BUILD_CONFIG_NAME: malte
                command: bundle exec fastlane build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE} scheme:${BUILD_CONFIG_NAME}
                working_directory: ios
            - run:
                name: Rename sourcemap
                command: mv ios/index.ios.bundle.map ios/output/malte.ios.bundle.map
      - run:
          name: "[FL] integreat-test-cms build"
          environment:
            BUILD_CONFIG_NAME: integreat-test-cms
            E2E_TEST_IDS: 1
          command: bundle exec fastlane build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE} scheme:${BUILD_CONFIG_NAME}
          working_directory: ios
      - run:
          name: Rename sourcemap
          command: mv ios/index.ios.bundlemap ios/output/integreat-test-cms.ios.bundle.map
      - store_artifacts:
          path: ios/output/gym/
      - persist_to_workspace:
          root: ios/output
          paths:
            - integreat.ios.bundle.map
            - malte.ios.bundle.map
            - integreat-test-cms.ios.bundle.map
      - persist_to_workspace:
          root: ios/output/gym/
          paths:
            - integreat.ipa
            - malte.ipa
            - integreat-test-cms.ipa

  bump_version:
    docker:
      - image: circleci/node:12.16.3
    resource_class: small
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_environment_variables
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
            - 2-yarn-{{ arch }}-
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
            - node_modules
      - run:
          name: Bump version
          command: tools/bump-version bump-to ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --branch ${CIRCLE_BRANCH}

  deliver_android:
    parameters:
      production_delivery:
        description: Whether to deliver the build to production.
        type: boolean
    docker:
      - image: circleci/android:api-28-node
    resource_class: small
    shell: /bin/bash -eo pipefail
    environment:
      FASTLANE_SKIP_UPDATE_CHECK: true
    steps:
      - run: 'curl -sL https://sentry.io/get-cli/ | bash'
      - checkout
      - attach_workspace:
          at: .
      - restore_environment_variables
      - restore_cache:
          keys:
            - 1-gems-{{ arch }}-{{ checksum "Gemfile.lock" }}
            - 1-gems-{{ arch }}-
      - run:
          command: bundle check || bundle install --path vendor/bundle
      - save_cache:
          key: 1-gems-{{ arch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - run:
          name: "[FL] Browserstack Upload Live"
          command: bundle exec fastlane android browserstack_upload_live app_name:integrat
      - run:
          name: "[FL] Play Store Upload"
          command: bundle exec fastlane android playstore_upload app_name:integreat production_delivery:"<< parameters.production_delivery >>" version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
      - run:
          name: "[FL] Upload to Sentry"
          command: bundle exec fastlane android sentry_upload app_name:integreat version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
      - slack/notify:
          message: Integreat ${NEW_VERSION_NAME} has been released successfully on Android!
          webhook: ${SLACK_URL}

  deliver_ios:
    parameters:
      production_delivery:
        description: Whether to deliver the build to production.
        type: boolean
    macos:
      xcode: 11.2.0
    environment:
      FASTLANE_SKIP_UPDATE_CHECK: true
    shell: /bin/bash --login -o pipefail
    steps:
      - run: 'curl -sL https://sentry.io/get-cli/ | bash'
      - checkout
      - attach_workspace:
          at: .
      - restore_environment_variables
      - restore_cache:
          keys:
            - 1-gems-{{ arch }}-{{ checksum "Gemfile.lock" }}
            - 1-gems-{{ arch }}-
      - run:
          command: bundle check || bundle install --path vendor/bundle
      - save_cache:
          key: 1-gems-{{ arch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - run:
          name: "[FL] Browserstack Upload Live"
          command: bundle exec fastlane ios browserstack_upload_live app_name:integreat
      - when:
          condition: << parameters.production_delivery >>
          steps:
            - run:
                name: "[FL] App Store Connect Upload"
                command: bundle exec fastlane ios appstoreconnect_upload app_name:integreat
      - unless:
          condition: << parameters.production_delivery >>
          steps:
            - run:
                name: "[FL] TestFlight Upload"
                command: bundle exec fastlane ios testflight_upload app_name:integreat version_name:${NEW_VERSION_NAME}
      - run:
          name: "[FL] Upload to Sentry"
          command: bundle exec fastlane ios sentry_upload app_name:integreat version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
      - slack/notify:
         message: Integreat ${NEW_VERSION_NAME} has been released successfully on iOS!
         webhook: ${SLACK_URL}

  e2e:
    docker:
      - image: circleci/android:api-28-node
    resource_class: small
    shell: /bin/bash -eo pipefail
    environment:
      FASTLANE_SKIP_UPDATE_CHECK: true
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_environment_variables
      - restore_cache:
          keys:
            - 1-gems-{{ arch }}-{{ checksum "Gemfile.lock" }}
            - 1-gems-{{ arch }}-
      - run:
          command: bundle check || bundle install --path vendor/bundle
      - save_cache:
          key: 1-gems-{{ arch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: 2-yarn-{{ arch }}-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
            - node_modules
      - run:
          name: "[FL] Android E2E Tests on Browserstack"
          command: bundle exec fastlane android browserstack_e2e_tests app_name:integreat-test-cms
      - run:
          name: "[FL] iOS E2E Tests on Browserstack"
          command: bundle exec fastlane ios browserstack_e2e_tests app_name:integreat-test-cms
