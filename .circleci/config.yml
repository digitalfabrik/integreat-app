### AUTO GENERATED. DO NOT MODIFY. ###
# This file should be auto generated by the files in the src folder.
# You can update it by running `yarn run circleci:update-config`.
commands:
    check_config:
        description: This command builds the circle config from the files in src and validates that it is up-to-date and valid.
        steps:
            - run:
                command: curl -fLSs https://raw.githubusercontent.com/CircleCI-Public/circleci-cli/master/install.sh | sudo bash
                name: Install CircleCI CLI
            - run:
                command: yarn run circleci:update-config
                name: Build circle config
            - run:
                command: |
                    FILES_MODIFIED=""
                    setcommit () {
                      FILES_MODIFIED=$(git status -s | grep -i -E '.*circleci/config.yml')
                    }
                    setcommit || true
                    if [ -z "$FILES_MODIFIED" ]
                    then
                      echo "The CircleCI config is up to date."
                      exit 0;
                    else
                      echo "The CircleCI config is not up to date. You can update it by running `yarn run circleci:update-config`."
                      exit 1;
                    fi
                name: CircleCI config up to date
            - run:
                command: circleci config validate
                name: Validate circle config
    notify:
        description: Send a notification (to Mattermost) at the end of a job, based on success or failure. Must be the last step in a job.
        parameters:
            channel:
                default: integreat-app-notifications
                type: string
            failure_mentions:
                default: '@steffen.kleinle @stefanie.metzger @andreas.fischer @leandra.hahn'
                type: string
            only_for_branch:
                default: main
                type: string
            success_mentions:
                default: ""
                type: string
            success_message:
                default: ""
                type: string
        steps:
            - run:
                command: |
                    if [ -n "<< parameters.failure_mentions >>" ]; then
                        echo 'export MM_MESSAGE=":fire: The [${CIRCLE_JOB}](${CIRCLE_BUILD_URL}) job has failed on the main branch! :fire:\n<< parameters.failure_mentions >>"' >> $BASH_ENV
                    else
                        echo 'export MM_MESSAGE=":fire: The [${CIRCLE_JOB}](${CIRCLE_BUILD_URL}) job has failed on the main branch! :fire:"' >> $BASH_ENV
                    fi
                name: Mattermost - Prepare failure message
                when: on_fail
            - run:
                command: |
                    if [ -n "<< parameters.success_message >>" ]; then
                        if [ -n "<< parameters.success_mentions >>" ]; then
                            echo 'export MM_MESSAGE="<< parameters.success_message >>\n<< parameters.success_mentions >>"' >> $BASH_ENV
                        else
                            echo 'export MM_MESSAGE="<< parameters.success_message >>"' >> $BASH_ENV
                        fi
                    fi
                name: Mattermost - Prepare success message
                when: on_success
            - run:
                command: tools/notify-mattermost << parameters.only_for_branch >> << parameters.channel >>
                name: Mattermost Status Alert
                when: always
    persist_environment_variables:
        description: Sets the environment variables specified in the file 'environment_variables'. Make sure the file is persisted and has been attached.
        steps:
            - run:
                command: cat ${BASH_ENV}
                name: List environment variables
            - run:
                command: cat ${BASH_ENV} >> environment_variables
                name: Save environment variables to file
            - persist_to_workspace:
                paths:
                    - environment_variables
                root: ./
    prepare_workspace:
        description: Attach the workspace at ~/attached_workspace and list its contents
        steps:
            - attach_workspace:
                at: ~/attached_workspace
            - run:
                command: ls -A ~/attached_workspace
                name: Attached workspace contents
            - run:
                command: ls -AR ~/attached_workspace
                name: Recursively list attached workspace contents
    restore_cocoa_pods_cache:
        description: Restores and saves the cocoa pods cache.
        steps:
            - restore_cache:
                keys:
                    - 6-pods-{{ arch }}-{{ checksum "native/ios/Podfile.lock" }}
                name: Restore CocoaPods Cache
            - run:
                command: bundle exec pod install
                name: '[CP] Install CocoaPods'
                working_directory: native/ios
            - save_cache:
                key: 6-pods-{{ arch }}-{{ checksum "native/ios/Podfile.lock" }}
                name: Save CocoaPods Cache
                paths:
                    - ~/Library/Caches/CocoaPods/
    restore_environment_variables:
        description: Sets the environment variables specified in the file 'environment_variables'. Make sure the file is persisted and has been attached.
        steps:
            - run:
                command: cat ~/attached_workspace/environment_variables
                name: List environment variables
            - run:
                command: cat ~/attached_workspace/environment_variables >> ${BASH_ENV}
                name: Restore environment variables
    restore_gradle_cache:
        description: Restores and saves the gradle cache.
        steps:
            - restore_cache:
                keys:
                    - 1-gradle-{{ checksum "native/android/build.gradle" }}-{{ checksum "native/android/app/build.gradle" }}-{{ checksum "native/android/settings.gradle" }}
                    - 1-gradle-
            - run:
                command: bundle exec fastlane dependencies
                name: '[FL] Download Dependencies'
                working_directory: native/android
            - save_cache:
                key: 1-gradle-{{ checksum "native/android/build.gradle" }}-{{ checksum "native/android/app/build.gradle" }}-{{ checksum "native/android/settings.gradle" }}
                paths:
                    - ~/.gradle
    restore_ruby_cache:
        description: Restores and saves fastlane cache of the passed directory.
        parameters:
            directory:
                default: native
                type: string
        steps:
            - restore_cache:
                keys:
                    - 3-gems-{{ arch }}-{{ checksum "<< parameters.directory >>/Gemfile.lock" }}
                    - 3-gems-{{ arch }}-
            - run:
                command: bundle check || bundle install
                name: '[FL] install'
                working_directory: << parameters.directory >>
            - save_cache:
                key: 3-gems-{{ arch }}-{{ checksum "<< parameters.directory >>/Gemfile.lock" }}
                paths:
                    - << parameters.directory >>/vendor/bundle
    restore_yarn_cache:
        description: Restores and saves the node_modules directories of the monorepo.
        steps:
            - restore_cache:
                keys:
                    - 8-yarn-{{ arch }}-{{ checksum "yarn.lock" }}-{{ checksum "package.json" }}-{{ checksum "native/package.json" }}-{{ checksum "web/package.json" }}
                    - 8-yarn-{{ arch }}-
                name: Restore Yarn Package Cache
            - run:
                command: yarn --frozen-lockfile --cache-folder ~/.cache/yarn
                name: Yarn
            - save_cache:
                key: 8-yarn-{{ arch }}-{{ checksum "yarn.lock" }}-{{ checksum "package.json" }}-{{ checksum "native/package.json" }}-{{ checksum "web/package.json" }}
                name: Save Yarn Package Cache
                paths:
                    - ~/.cache/yarn
                    - node_modules
                    - native/node_modules
                    - web/node_modules
    restore_yarn_tools_cache:
        description: Restores and saves the node_modules directories of the tools package.
        steps:
            - restore_cache:
                keys:
                    - 2-yarn-{{ arch }}-{{ checksum "tools/yarn.lock" }}-{{ checksum "tools/package.json" }}
                name: Restore Yarn Tools Package Cache
            - run:
                command: yarn --frozen-lockfile --cache-folder ~/.cache/yarn-tools
                name: Yarn tools
                working_directory: tools
            - save_cache:
                key: 2-yarn-{{ arch }}-{{ checksum "tools/yarn.lock" }}-{{ checksum "tools/package.json" }}
                name: Save Yarn Tools Package Cache
                paths:
                    - ~/.cache/yarn-tools
                    - tools/node_modules
    skip_job:
        description: Skips the current build if neccassary
        parameters:
            build_config_name:
                default: all
                enum:
                    - integreat
                    - malte
                    - integreat-e2e
                    - integreat-test-cms
                    - malte-test-cms
                    - aschaffenburg
                    - obdach
                    - all
                type: enum
        steps:
            - run:
                command: |
                    function skip_job {
                      build_config_name=$1
                      variable_name=SKIP_JOB_${CIRCLE_JOB%-*} # Remove everything after "-". e.g. "check-1" -> check
                      if [[ -n ${!variable_name} && ($build_config_name =~ ${!variable_name} || "all" =~  ${!variable_name}) ]]; then
                        message="Job is skipped because the variable $variable_name is set"
                        echo $message
                        circleci step halt
                        source tools/notify-mattermost main integreat-app-notifications "$message"
                      fi
                    }

                    skip_job << parameters.build_config_name >>
                name: Skip the current build if necessary
    unit_test:
        description: Runs the test task and stores coverage and junit data
        steps:
            - run:
                command: |
                    # download test reporter as a static binary
                    curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
                    chmod +x ./cc-test-reporter
                name: Setup Code Climate test-reporter
            - run:
                command: ./cc-test-reporter before-build
                name: Code Climate before build
            - run:
                command: yarn test:ci --maxWorkers ${TOTAL_CPUS}
                name: Unit Tests with Coverage
            - run:
                command: |
                    ./cc-test-reporter format-coverage -t lcov -o reports/coverage/codeclimate.json reports/coverage/lcov.info
                    ./cc-test-reporter upload-coverage -i reports/coverage/codeclimate.json
                name: Code Climate after build
            - store_test_results:
                path: reports/unit-test
            - store_artifacts:
                path: reports/coverage
jobs:
    build_android:
        docker:
            - image: cimg/android:2023.02.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
            TOTAL_CPUS: 4
        parameters:
            build_config_name:
                default: integreat
                enum:
                    - integreat
                    - malte
                    - integreat-e2e
                    - integreat-test-cms
                    - aschaffenburg
                type: enum
        resource_class: large
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job:
                build_config_name: << parameters.build_config_name >>
            - add_ssh_keys:
                fingerprints:
                    - 24:1d:3b:b7:b3:49:69:d7:54:c3:93:a5:a2:d1:71:db
            - prepare_workspace
            - restore_environment_variables
            - restore_yarn_cache
            - restore_ruby_cache:
                directory: native/android
            - restore_gradle_cache
            - run:
                command: bundle exec fastlane keystore
                name: '[FL] Prepare Android Keystore'
                working_directory: native/android
            - run:
                command: ./gradlew clean && bundle exec fastlane build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE} build_config_name:<< parameters.build_config_name >>
                name: '[FL] << parameters.build_config_name >> build'
                working_directory: native/android
            - run:
                command: |
                    mkdir -p sourcemaps/<< parameters.build_config_name >>
                    cp native/android/app/build/generated/sourcemaps/react/release/index.android.bundle.map sourcemaps/<< parameters.build_config_name >>/
                    cp native/android/app/build/ASSETS/createBundleReleaseJsAndAssets/index.android.bundle sourcemaps/<< parameters.build_config_name >>/
                name: Prepare Sourcemaps
            - persist_to_workspace:
                paths:
                    - sourcemaps/<< parameters.build_config_name >>/*
                root: .
            - run:
                command: mv app/build/outputs/apk/release/app-release.apk << parameters.build_config_name >>.apk
                name: Rename apk
                working_directory: native/android
            - store_artifacts:
                path: native/android/<< parameters.build_config_name >>.apk
            - persist_to_workspace:
                paths:
                    - << parameters.build_config_name >>.apk
                root: native/android
            - unless:
                condition:
                    or:
                        - equal:
                            - integreat-e2e
                            - << parameters.build_config_name >>
                        - equal:
                            - integreat-test-cms
                            - << parameters.build_config_name >>
                steps:
                    - run:
                        command: echo "[<< parameters.build_config_name >>.apk](https://output.circle-artifacts.com/output/job/$CIRCLE_WORKFLOW_JOB_ID/artifacts/0/native/android/<< parameters.build_config_name >>.apk)" >> << parameters.build_config_name >>-apk-url
                        name: Persist artifact url
                    - persist_to_workspace:
                        paths:
                            - << parameters.build_config_name >>-apk-url
                        root: ./
            - notify
    build_ios:
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
            FL_OUTPUT_DIR: output
            TOTAL_CPUS: 4
        macos:
            xcode: 15.0.1
        parameters:
            build_config_name:
                default: integreat
                enum:
                    - integreat
                    - malte
                    - integreat-e2e
                    - integreat-test-cms
                    - aschaffenburg
                type: enum
        resource_class: macos.m1.medium.gen1
        shell: /bin/bash --login -o pipefail
        steps:
            - checkout
            - skip_job:
                build_config_name: << parameters.build_config_name >>
            - add_ssh_keys:
                fingerprints:
                    - 24:1d:3b:b7:b3:49:69:d7:54:c3:93:a5:a2:d1:71:db
            - prepare_workspace
            - restore_environment_variables
            - restore_yarn_cache
            - restore_ruby_cache:
                directory: native/ios
            - restore_cocoa_pods_cache
            - run:
                command: bundle exec fastlane build version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE} build_config_name:<< parameters.build_config_name >>
                name: '[FL] << parameters.build_config_name >> build'
                working_directory: native/ios
            - run:
                command: |
                    mkdir -p sourcemaps/<< parameters.build_config_name >>
                    cp native/ios/output/<< parameters.build_config_name >>.ios.bundle* sourcemaps/<< parameters.build_config_name >>/
                name: Prepare Sourcemaps
            - persist_to_workspace:
                paths:
                    - sourcemaps/<< parameters.build_config_name >>/*
                root: .
            - store_artifacts:
                path: native/ios/output/gym/<< parameters.build_config_name >>.ipa
            - persist_to_workspace:
                paths:
                    - << parameters.build_config_name >>.ipa
                root: native/ios/output/gym
            - unless:
                condition:
                    or:
                        - equal:
                            - integreat-e2e
                            - << parameters.build_config_name >>
                        - equal:
                            - integreat-test-cms
                            - << parameters.build_config_name >>
                steps:
                    - run:
                        command: echo "[<< parameters.build_config_name >>.ipa](https://output.circle-artifacts.com/output/job/$CIRCLE_WORKFLOW_JOB_ID/artifacts/0/native/ios/output/gym/<< parameters.build_config_name >>.ipa)" >> << parameters.build_config_name >>-ipa-url
                        name: Persist artifact url
                    - persist_to_workspace:
                        paths:
                            - << parameters.build_config_name >>-ipa-url
                        root: ./
            - notify
    build_web:
        docker:
            - image: cimg/node:20.12.1
        environment:
            TOTAL_CPUS: 2
        parameters:
            build_config_name:
                default: integreat
                enum:
                    - integreat
                    - malte
                    - integreat-test-cms
                    - malte-test-cms
                    - aschaffenburg
                    - obdach
                type: enum
        resource_class: medium
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job:
                build_config_name: << parameters.build_config_name >>
            - restore_yarn_cache
            - prepare_workspace
            - restore_environment_variables
            - run:
                command: yarn workspace web build:<< parameters.build_config_name >> --env commit_sha=${CIRCLE_SHA1} --env version_name=${NEW_VERSION_NAME}
                name: << parameters.build_config_name >> build
            - store_artifacts:
                name: Store output of bundle analyzer
                path: web/reports/bundle
            - run:
                command: yarn workspace web check:build
                name: Check build
            - run:
                command: tar -czf << parameters.build_config_name >>.tar.gz ./<< parameters.build_config_name >>
                name: Create tarball
                working_directory: web/dist
            - store_artifacts:
                path: web/dist/<< parameters.build_config_name >>.tar.gz
            - persist_to_workspace:
                paths:
                    - dist
                root: web
            - notify
    bump_version:
        docker:
            - image: cimg/node:20.12.1
        parameters:
            prepare_delivery:
                default: false
                description: Whether to prepare for a delivery. If true, the version bump is committed.
                type: boolean
        resource_class: small
        steps:
            - checkout
            - skip_job
            - restore_yarn_tools_cache
            - run:
                command: echo "export NEW_VERSION_NAME=$(yarn --silent next-version calc | jq .versionName)" >> ${BASH_ENV}
                name: Calculate next version name
                working_directory: tools
            - run:
                command: echo "export NEW_VERSION_CODE=$(yarn --silent next-version calc | jq .versionCode)" >> ${BASH_ENV}
                name: Calculate next version code
                working_directory: tools
            - when:
                condition: << parameters.prepare_delivery >>
                steps:
                    - run:
                        command: yarn git-version bump-to ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --branch ${CIRCLE_BRANCH}
                        name: Bump git version
                        working_directory: tools
            - when:
                condition:
                    and:
                        - << parameters.prepare_delivery >>
                        - not:
                            equal:
                                - main
                                - << pipeline.git.branch >>
                steps:
                    - notify:
                        only_for_branch: ${CIRCLE_BRANCH}
                        success_message: Delivery was made on branch << pipeline.git.branch >>. Make sure to merge this branch before next delivery.
            - persist_environment_variables
            - notify
    check:
        docker:
            - image: cimg/node:20.12.1
        environment:
            TOTAL_CPUS: 1
            TZ: Europe/Berlin
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job
            - check_config
            - restore_yarn_cache
            - restore_yarn_tools_cache
            - run:
                command: yarn prettier:check
                name: Prettier
            - run:
                command: yarn ts:check:ci
                name: TS check
            - run:
                command: yarn lint:ci
                name: Lint
            - store_test_results:
                path: reports/lint
            - run:
                command: yarn workspace native stylelint
                name: Stylelint
            - run:
                command: yarn workspace web stylelint
                name: Stylelint
            - unit_test
            - notify
    deliver_android:
        docker:
            - image: cimg/android:2023.02.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        parameters:
            build_config_name:
                default: integreat
                enum:
                    - integreat
                    - malte
                    - aschaffenburg
                type: enum
            production_delivery:
                description: Whether to deliver the build to production.
                type: boolean
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job:
                build_config_name: << parameters.build_config_name >>
            - prepare_workspace
            - restore_environment_variables
            - restore_yarn_tools_cache
            - restore_yarn_cache
            - restore_ruby_cache:
                directory: native
            - run:
                command: yarn --cwd tools manage-metadata prepare-metadata << parameters.build_config_name >> playstore
                name: Prepare Play Store metadata
            - run:
                command: bundle exec fastlane browserstack_upload_live path:attached_workspace/<< parameters.build_config_name >>.apk
                name: '[FL] Browserstack Upload Live'
                working_directory: native
            - run:
                command: bundle exec fastlane android playstore_upload build_config_name:<< parameters.build_config_name >> apk_path:attached_workspace/<< parameters.build_config_name >>.apk production_delivery:"<< parameters.production_delivery >>" version_name:${NEW_VERSION_NAME} version_code:${NEW_VERSION_CODE}
                name: '[FL] Play Store Upload'
                working_directory: native
            - notify
    deliver_ios:
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        macos:
            xcode: 15.0.1
        parameters:
            build_config_name:
                default: integreat
                enum:
                    - integreat
                    - malte
                    - aschaffenburg
                type: enum
            production_delivery:
                description: Whether to deliver the build to production.
                type: boolean
        shell: /bin/bash --login -o pipefail
        steps:
            - checkout
            - skip_job:
                build_config_name: << parameters.build_config_name >>
            - prepare_workspace
            - restore_environment_variables
            - restore_yarn_tools_cache
            - restore_yarn_cache
            - restore_ruby_cache:
                directory: native
            - run:
                command: yarn --cwd tools manage-metadata prepare-metadata << parameters.build_config_name >> appstore
                name: Prepare App Store metadata
            - run:
                command: bundle exec fastlane browserstack_upload_live path:attached_workspace/<< parameters.build_config_name >>.ipa
                name: '[FL] Browserstack Upload Live'
                working_directory: native
            - when:
                condition: << parameters.production_delivery >>
                steps:
                    - run:
                        command: bundle exec fastlane ios appstoreconnect_upload ipa_path:attached_workspace/<< parameters.build_config_name >>.ipa version_name:${NEW_VERSION_NAME} build_config_name:<< parameters.build_config_name >>
                        name: '[FL] App Store Connect Upload'
                        working_directory: native
            - unless:
                condition: << parameters.production_delivery >>
                steps:
                    - run:
                        command: bundle exec fastlane ios testflight_upload build_config_name:<< parameters.build_config_name >> ipa_path:attached_workspace/<< parameters.build_config_name >>.ipa
                        name: '[FL] TestFlight Upload'
                        working_directory: native
            - notify
    deliver_web:
        docker:
            - image: cimg/node:20.12.1
        parameters:
            delivery:
                description: Whether to deliver to production, beta or to webnext.
                enum:
                    - production
                    - beta
                    - webnext
                type: enum
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job
            - add_ssh_keys:
                fingerprints:
                    - 68:a3:fe:e7:94:f7:a4:13:35:5c:63:30:2f:07:7d:02
            - prepare_workspace
            - restore_environment_variables
            - run:
                command: sudo apt update && sudo apt install rsync
                name: Install rsync
            - when:
                condition:
                    equal:
                        - production
                        - << parameters.delivery >>
                steps:
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/integreat/ web@web.integreat-app.de:/var/www/integreat.app
                        name: Integreat production delivery
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/malte/ web@web.integreat-app.de:/var/www/malteapp.de
                        name: Malte production delivery
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/aschaffenburg/ web@web.integreat-app.de:/var/www/aschaffenburg.app
                        name: Aschaffenburg production delivery
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/obdach/ web@web.integreat-app.de:/var/www/netzwerkobdachwohnen.de
                        name: Obdach production delivery
            - when:
                condition:
                    equal:
                        - beta
                        - << parameters.delivery >>
                steps:
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/integreat/ web@web.integreat-app.de:/var/www/beta.integreat.app
                        name: Integreat beta delivery
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/malte/ web@web.integreat-app.de:/var/www/beta.malteapp.de
                        name: Malte beta delivery
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/aschaffenburg/ web@web.integreat-app.de:/var/www/beta.aschaffenburg.app
                        name: Aschaffenburg beta delivery
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/obdach/ web@web.integreat-app.de:/var/www/beta.netzwerkobdachwohnen.de
                        name: Obdach beta delivery
            - when:
                condition:
                    equal:
                        - webnext
                        - << parameters.delivery >>
                steps:
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/integreat-test-cms/ web@web.integreat-app.de:/var/www/webnext.integreat.app
                        name: Integreat webnext delivery
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/malte-test-cms/ web@web.integreat-app.de:/var/www/webnext.malteapp.de
                        name: Malte webnext delivery
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/aschaffenburg/ web@web.integreat-app.de:/var/www/webnext.aschaffenburg.app
                        name: Aschaffenburg webnext delivery
                    - run:
                        command: rsync -e "ssh -o StrictHostKeyChecking=no" -arv --delete $HOME/attached_workspace/dist/obdach/ web@web.integreat-app.de:/var/www/webnext.netzwerkobdachwohnen.de
                        name: Obdach webnext delivery
            - notify
    e2e_android:
        docker:
            - image: cimg/android:2023.02.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_yarn_cache
            - restore_ruby_cache:
                directory: native
            - run:
                command: bundle exec fastlane android browserstack_e2e_tests apk_path:attached_workspace/integreat-e2e.apk
                name: '[FL] Android E2E Tests on Browserstack'
                working_directory: native
            - notify
    e2e_ios:
        docker:
            - image: cimg/android:2023.02.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_yarn_cache
            - restore_ruby_cache:
                directory: native
            - run:
                command: bundle exec fastlane ios browserstack_e2e_tests ipa_path:attached_workspace/integreat-e2e.ipa
                name: '[FL] iOS E2E Tests on Browserstack'
                working_directory: native
            - notify
    e2e_web:
        docker:
            - image: cimg/node:20.12.1-browsers
            - image: selenium/standalone-chrome
        resource_class: medium
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_yarn_cache
            - run:
                background: true
                command: yarn workspace web start:integreat-e2e
                name: Start WebApp
            - run:
                command: yarn workspace e2e test:web
                name: Web E2E Tests
            - notify
    move_release_notes:
        docker:
            - image: cimg/node:20.12.1
        resource_class: small
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_environment_variables
            - restore_yarn_tools_cache
            - run:
                command: yarn move-release-notes move-to ${NEW_VERSION_NAME} --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --branch ${CIRCLE_BRANCH}
                name: Move release notes
                working_directory: tools
            - notify
    notify_android:
        docker:
            - image: cimg/node:20.12.1
        parameters:
            production_delivery:
                description: Whether builds are delivered to the production or beta lane of the play store.
                type: boolean
        resource_class: small
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_environment_variables
            - restore_yarn_tools_cache
            - run:
                command: echo "export ANDROID_ARTIFACT_URLS='$(echo $(cat $(ls | grep apk-url)))'" >> ${BASH_ENV}
                name: Prepare artifact urls
                working_directory: ~/attached_workspace
            - run:
                command: echo "export ANDROID_RELEASE_ID='$(yarn --silent github-release create android ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --production-delivery << parameters.production_delivery >> --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --release-notes "$(yarn --silent manage-metadata parse-release-notes --android --language en)")'" >> ${BASH_ENV}
                name: Create github release
                working_directory: tools
            - run:
                command: yarn github-release-asset upload android --releaseId ${ANDROID_RELEASE_ID} --files "$(ls ~/attached_workspace/*.apk)" --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Upload apks to github release
                working_directory: tools
            - run:
                command: echo "export RELEASE_NOTES=$(yarn --silent --cwd tools manage-metadata parse-release-notes --android --language en)" >> ${BASH_ENV}
                name: Create release notes
            - notify:
                channel: releases
                only_for_branch: ${CIRCLE_BRANCH}
                success_message: <<^ parameters.production_delivery >>[Beta] <</ parameters.production_delivery >>Integreat, Malte and Aschaffenburg ${NEW_VERSION_NAME} have been released successfully on Android!\n${RELEASE_NOTES}\n${ANDROID_ARTIFACT_URLS}
    notify_ios:
        docker:
            - image: cimg/node:20.12.1
        parameters:
            production_delivery:
                description: Whether builds are delivered to the app store or testflight.
                type: boolean
        resource_class: small
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_environment_variables
            - restore_yarn_tools_cache
            - run:
                command: echo "export IOS_ARTIFACT_URLS='$(echo $(cat $(ls | grep ipa-url)))'" >> ${BASH_ENV}
                name: Prepare artifact urls
                working_directory: ~/attached_workspace
            - run:
                command: echo "export IOS_RELEASE_ID='$(yarn --silent github-release create ios ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --production-delivery << parameters.production_delivery >> --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --release-notes "$(yarn --silent manage-metadata parse-release-notes --ios --language en)")'" >> ${BASH_ENV}
                name: Create github release
                working_directory: tools
            - run:
                command: yarn github-release-asset upload ios --releaseId ${IOS_RELEASE_ID} --files "$(ls ~/attached_workspace/*.ipa)" --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Upload ipas to github release
                working_directory: tools
            - run:
                command: echo "export RELEASE_NOTES=$(yarn --silent --cwd tools manage-metadata parse-release-notes --ios --language en)" >> ${BASH_ENV}
                name: Create release notes
            - notify:
                channel: releases
                only_for_branch: ${CIRCLE_BRANCH}
                success_message: <<^ parameters.production_delivery >>[Beta] <</ parameters.production_delivery >>Integreat, Malte and Aschaffenburg ${NEW_VERSION_NAME} have been released successfully on iOS!\n${RELEASE_NOTES}\n${IOS_ARTIFACT_URLS}
    notify_web:
        docker:
            - image: cimg/node:20.12.1
        parameters:
            production_delivery:
                description: Whether builds are delivered to production or beta.
                type: boolean
        resource_class: small
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_environment_variables
            - restore_yarn_tools_cache
            - run:
                command: yarn github-release create web ${NEW_VERSION_NAME} ${NEW_VERSION_CODE} --production-delivery << parameters.production_delivery >> --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME} --release-notes "$(yarn --silent manage-metadata parse-release-notes --web --language en)"
                name: Create github release
                working_directory: tools
            - run:
                command: echo "export RELEASE_NOTES=$(yarn --silent --cwd tools manage-metadata parse-release-notes --web --language en)" >> ${BASH_ENV}
                name: Create release notes
            - when:
                condition: << parameters.production_delivery >>
                steps:
                    - notify:
                        channel: releases
                        success_message: WebApp version ${NEW_VERSION_NAME} was delivered successfully to integreat.app, malteapp.de, aschaffenburg.app and netzwerkobdachwohnen.de!\n${RELEASE_NOTES}
            - unless:
                condition: << parameters.production_delivery >>
                steps:
                    - notify:
                        channel: releases
                        only_for_branch: ${CIRCLE_BRANCH}
                        success_message: |-
                            [Beta] WebApp version ${NEW_VERSION_NAME} was delivered successfully to beta.integreat.app, beta.malteapp.de, beta.aschaffenburg.app and beta.netzwerkobdachwohnen.de!
                            ${RELEASE_NOTES}
    promote_android:
        docker:
            - image: cimg/android:2023.02.1-node
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        parameters:
            build_config_name:
                default: integreat
                enum:
                    - integreat
                    - malte
                    - aschaffenburg
                type: enum
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job:
                build_config_name: << parameters.build_config_name >>
            - restore_yarn_cache
            - restore_yarn_tools_cache
            - restore_ruby_cache:
                directory: native
            - run:
                command: bundle exec fastlane android playstore_promote build_config_name:<< parameters.build_config_name >>
                name: '[FL] Play Store Promotion'
                working_directory: native
            - run:
                command: yarn github-promote-release promote --platform android --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Remove prerelease flag from github release
                working_directory: tools
            - notify
    promote_ios:
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        macos:
            xcode: 15.0.1
        parameters:
            build_config_name:
                default: integreat
                enum:
                    - integreat
                    - malte
                    - aschaffenburg
                type: enum
        shell: /bin/bash --login -o pipefail
        steps:
            - checkout
            - skip_job:
                build_config_name: << parameters.build_config_name >>
            - restore_yarn_tools_cache
            - restore_yarn_cache
            - restore_ruby_cache:
                directory: native
            - run:
                command: bundle exec fastlane ios appstoreconnect_promote build_config_name:<< parameters.build_config_name >>
                name: '[FL] App Store Connect Promotion'
                working_directory: native
            - run:
                command: yarn github-promote-release promote --platform ios --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Remove prerelease flag from github release
                working_directory: tools
            - notify
    promote_web:
        docker:
            - image: cimg/node:20.12.1
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job
            - restore_yarn_tools_cache
            - add_ssh_keys:
                fingerprints:
                    - 68:a3:fe:e7:94:f7:a4:13:35:5c:63:30:2f:07:7d:02
            - run:
                command: ssh -o StrictHostKeyChecking=no web@web.integreat-app.de "rsync -arv --delete /var/www/beta.integreat.app/ /var/www/integreat.app"
                name: Integreat production promotion
            - run:
                command: ssh -o StrictHostKeyChecking=no web@web.integreat-app.de "rsync -arv --delete /var/www/beta.malteapp.de/ /var/www/malteapp.de"
                name: Malte production promotion
            - run:
                command: ssh -o StrictHostKeyChecking=no web@web.integreat-app.de "rsync -arv --delete /var/www/beta.aschaffenburg.app/ /var/www/aschaffenburg.app"
                name: Aschaffenburg production promotion
            - run:
                command: ssh -o StrictHostKeyChecking=no web@web.integreat-app.de "rsync -arv --delete /var/www/beta.netzwerkobdachwohnen.de/ /var/www/netzwerkobdachwohnen.de"
                name: Obdach production promotion
            - run:
                command: yarn github-promote-release promote --platform web --deliverino-private-key ${DELIVERINO_PRIVATE_KEY} --owner ${CIRCLE_PROJECT_USERNAME} --repo ${CIRCLE_PROJECT_REPONAME}
                name: Remove prerelease flag from github release
                working_directory: tools
            - notify
    sentry_android:
        docker:
            - image: cimg/node:20.12.1
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_environment_variables
            - run:
                command: tools/sentry-release tuerantuer.app.integreat "${NEW_VERSION_NAME}" ~/attached_workspace/sourcemaps/integreat --version-code "${NEW_VERSION_CODE}"
                name: 'Sentry Upload: integreat'
            - run:
                command: tools/sentry-release de.malteapp "${NEW_VERSION_NAME}" ~/attached_workspace/sourcemaps/malte --version-code "${NEW_VERSION_CODE}"
                name: 'Sentry Upload: malte'
            - run:
                command: tools/sentry-release app.aschaffenburg "${NEW_VERSION_NAME}" ~/attached_workspace/sourcemaps/aschaffenburg --version-code "${NEW_VERSION_CODE}"
                name: 'Sentry Upload: aschaffenburg'
            - notify
    sentry_ios:
        docker:
            - image: cimg/node:20.12.1
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_environment_variables
            - run:
                command: tools/sentry-release de.integreat-app "${NEW_VERSION_NAME}" ~/attached_workspace/sourcemaps/integreat --version-code "${NEW_VERSION_CODE}"
                name: 'Sentry Upload: integreat'
            - run:
                command: tools/sentry-release de.malteapp "${NEW_VERSION_NAME}" ~/attached_workspace/sourcemaps/malte --version-code "${NEW_VERSION_CODE}"
                name: 'Sentry Upload: malte'
            - run:
                command: tools/sentry-release app.aschaffenburg "${NEW_VERSION_NAME}" ~/attached_workspace/sourcemaps/aschaffenburg --version-code "${NEW_VERSION_CODE}"
                name: 'Sentry Upload: aschaffenburg'
            - notify
    sentry_web:
        docker:
            - image: cimg/node:20.12.1
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_environment_variables
            - run:
                command: tools/sentry-release web-integreat "${NEW_VERSION_NAME}" ~/attached_workspace/dist/integreat
                name: 'Sentry Upload: integreat'
            - run:
                command: tools/sentry-release web-malte "${NEW_VERSION_NAME}" ~/attached_workspace/dist/malte
                name: 'Sentry Upload: malte'
            - run:
                command: tools/sentry-release web-aschaffenburg "${NEW_VERSION_NAME}" ~/attached_workspace/dist/aschaffenburg
                name: 'Sentry Upload: aschaffenburg'
            - run:
                command: tools/sentry-release web-obdach "${NEW_VERSION_NAME}" ~/attached_workspace/dist/obdach
                name: 'Sentry Upload: obdach'
            - notify
    upload_browserstack:
        docker:
            - image: cimg/ruby:3.1.1
        environment:
            FASTLANE_SKIP_UPDATE_CHECK: true
        parameters:
            file_name:
                description: the name of the file to upload
                type: string
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - skip_job
            - prepare_workspace
            - restore_environment_variables
            - restore_ruby_cache:
                directory: native
            - run:
                command: |
                    file="attached_workspace/<< parameters.file_name >>"
                    file_with_commit_sha="${file%.*}_<< pipeline.git.revision >>.${file##*.}"
                    cp ~/$file ~/$file_with_commit_sha
                    bundle exec fastlane browserstack_upload_live path:$file_with_commit_sha
                name: '[FL] Browserstack Upload Live'
                working_directory: native
            - notify
parameters:
    api_triggered:
        default: false
        description: Whether the pipeline was triggered through the CircleCi API (https://circleci.com/docs/api/v2/?shell#trigger-a-new-pipeline).
        type: boolean
    workflow_type:
        default: none
        enum:
            - native_beta_delivery
            - native_production_delivery
            - native_promotion
            - web_beta_delivery
            - web_production_delivery
            - web_promotion
            - delivery
            - e2e_tests
            - none
        type: enum
version: 2.1
workflows:
    commit:
        jobs:
            - bump_version:
                context:
                    - mattermost
                prepare_delivery: false
            - check:
                context:
                    - codeclimate-integreat-app
                    - mattermost
            - build_web:
                build_config_name: integreat-test-cms
                context:
                    - mattermost
                name: build_ig_test_cms_web
                requires:
                    - bump_version
                    - check
            - e2e_web:
                context:
                    - mattermost
                requires:
                    - bump_version
                    - check
        unless:
            or:
                - equal:
                    - main
                    - << pipeline.git.branch >>
                - << pipeline.parameters.api_triggered >>
    commit_main:
        jobs:
            - bump_version:
                context:
                    - mattermost
                prepare_delivery: false
            - build_web:
                build_config_name: integreat-test-cms
                context:
                    - mattermost
                name: build_ig_test_cms_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: malte-test-cms
                context:
                    - mattermost
                name: build_malte_test_cms_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                name: build_aschaffenburg_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: obdach
                context:
                    - mattermost
                name: build_obdach_web
                requires:
                    - bump_version
            - deliver_web:
                context:
                    - mattermost
                    - sentry
                delivery: webnext
                requires:
                    - build_ig_test_cms_web
                    - build_malte_test_cms_web
                    - build_aschaffenburg_web
                    - build_obdach_web
            - build_android:
                build_config_name: integreat-test-cms
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_ig_test_cms_android
                requires:
                    - bump_version
            - upload_browserstack:
                context:
                    - mattermost
                    - browserstack
                file_name: integreat-test-cms.apk
                name: upload_ig_test_cms_android_browserstack
                requires:
                    - build_ig_test_cms_android
            - build_ios:
                build_config_name: integreat-test-cms
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_ig_test_cms_ios
                requires:
                    - bump_version
            - upload_browserstack:
                context:
                    - mattermost
                    - browserstack
                file_name: integreat-test-cms.ipa
                name: upload_ig_test_cms_ios_browserstack
                requires:
                    - build_ig_test_cms_ios
        when:
            and:
                - equal:
                    - main
                    - << pipeline.git.branch >>
                - not: << pipeline.parameters.api_triggered >>
    delivery:
        jobs:
            - bump_version:
                context:
                    - mattermost
                    - deliverino
                prepare_delivery: true
            - check:
                context:
                    - codeclimate-integreat-app
                    - mattermost
            - e2e_web:
                context:
                    - mattermost
                requires:
                    - bump_version
            - build_web:
                build_config_name: integreat
                context:
                    - mattermost
                name: build_integreat_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: malte
                context:
                    - mattermost
                name: build_malte_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                name: build_aschaffenburg_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: obdach
                context:
                    - mattermost
                name: build_obdach_web
                requires:
                    - bump_version
            - deliver_web:
                context:
                    - mattermost
                delivery: beta
                requires:
                    - check
                    - e2e_web
                    - build_integreat_web
                    - build_malte_web
                    - build_aschaffenburg_web
                    - build_obdach_web
            - sentry_web:
                context:
                    - mattermost
                    - sentry
                requires:
                    - build_integreat_web
                    - build_malte_web
                    - build_aschaffenburg_web
                    - build_obdach_web
            - notify_web:
                context:
                    - mattermost
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_web
            - build_android:
                build_config_name: integreat-e2e
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_e2e_android
                requires:
                    - bump_version
            - e2e_android:
                context:
                    - mattermost
                    - browserstack
                requires:
                    - build_e2e_android
            - build_android:
                build_config_name: integreat
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_integreat_android
                requires:
                    - bump_version
            - deliver_android:
                build_config_name: integreat
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-google-play
                name: deliver_integreat_android
                production_delivery: false
                requires:
                    - check
                    - e2e_android
                    - build_integreat_android
            - build_android:
                build_config_name: malte
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_malte_android
                requires:
                    - bump_version
            - deliver_android:
                build_config_name: malte
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-google-play
                name: deliver_malte_android
                production_delivery: false
                requires:
                    - check
                    - e2e_android
                    - build_malte_android
            - build_android:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_aschaffenburg_android
                requires:
                    - bump_version
            - deliver_android:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-google-play
                name: deliver_aschaffenburg_android
                production_delivery: false
                requires:
                    - check
                    - e2e_android
                    - build_aschaffenburg_android
            - sentry_android:
                context:
                    - mattermost
                    - sentry
                requires:
                    - build_integreat_android
                    - build_malte_android
                    - build_aschaffenburg_android
            - notify_android:
                context:
                    - mattermost
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_integreat_android
                    - deliver_malte_android
                    - deliver_aschaffenburg_android
            - build_ios:
                build_config_name: integreat-e2e
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_e2e_ios
                requires:
                    - bump_version
            - e2e_ios:
                context:
                    - mattermost
                    - browserstack
                requires:
                    - build_e2e_ios
            - build_ios:
                build_config_name: integreat
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_integreat_ios
                requires:
                    - bump_version
            - deliver_ios:
                build_config_name: integreat
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-apple
                name: deliver_integreat_ios
                production_delivery: false
                requires:
                    - check
                    - e2e_ios
                    - build_integreat_ios
            - build_ios:
                build_config_name: malte
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_malte_ios
                requires:
                    - bump_version
            - deliver_ios:
                build_config_name: malte
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-apple
                name: deliver_malte_ios
                production_delivery: false
                requires:
                    - check
                    - e2e_ios
                    - build_malte_ios
            - build_ios:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_aschaffenburg_ios
                requires:
                    - bump_version
            - deliver_ios:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-apple
                name: deliver_aschaffenburg_ios
                production_delivery: false
                requires:
                    - check
                    - e2e_ios
                    - build_aschaffenburg_ios
            - sentry_ios:
                context:
                    - mattermost
                    - sentry
                requires:
                    - build_integreat_ios
                    - build_malte_ios
                    - build_aschaffenburg_ios
            - notify_ios:
                context:
                    - mattermost
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_integreat_ios
                    - deliver_malte_ios
                    - deliver_aschaffenburg_ios
            - move_release_notes:
                context:
                    - mattermost
                    - deliverino
                requires:
                    - notify_web
                    - notify_android
                    - notify_ios
        when:
            and:
                - << pipeline.parameters.api_triggered >>
                - equal:
                    - << pipeline.parameters.workflow_type >>
                    - delivery
    e2e_tests:
        jobs:
            - bump_version:
                context:
                    - mattermost
                prepare_delivery: false
            - build_web:
                build_config_name: integreat-test-cms
                context:
                    - mattermost
                name: build_ig_test_cms_web
                requires:
                    - bump_version
            - e2e_web:
                context:
                    - mattermost
            - build_android:
                build_config_name: integreat-e2e
                context:
                    - credentials-repo
                    - credentials-integreat
                    - mattermost
                name: build_e2e_android
                requires:
                    - bump_version
            - e2e_android:
                context:
                    - browserstack
                    - mattermost
                requires:
                    - build_e2e_android
            - build_ios:
                build_config_name: integreat-e2e
                context:
                    - tuerantuer-apple
                    - fastlane-match
                    - mattermost
                name: build_e2e_ios
                requires:
                    - bump_version
            - e2e_ios:
                context:
                    - browserstack
                    - mattermost
                requires:
                    - build_e2e_ios
        when:
            or:
                - and:
                    - << pipeline.parameters.api_triggered >>
                    - equal:
                        - << pipeline.parameters.workflow_type >>
                        - e2e_tests
                - and:
                    - equal:
                        - main
                        - << pipeline.git.branch >>
                    - not: << pipeline.parameters.api_triggered >>
    native_beta_delivery:
        jobs:
            - bump_version:
                context:
                    - mattermost
                    - deliverino
                prepare_delivery: true
            - check:
                context:
                    - codeclimate-integreat-app
                    - mattermost
            - build_android:
                build_config_name: integreat-e2e
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_e2e_android
                requires:
                    - bump_version
            - e2e_android:
                context:
                    - mattermost
                    - browserstack
                requires:
                    - build_e2e_android
            - build_android:
                build_config_name: integreat
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_integreat_android
                requires:
                    - bump_version
            - deliver_android:
                build_config_name: integreat
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-google-play
                name: deliver_integreat_android
                production_delivery: false
                requires:
                    - check
                    - e2e_android
                    - build_integreat_android
            - build_android:
                build_config_name: malte
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_malte_android
                requires:
                    - bump_version
            - deliver_android:
                build_config_name: malte
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-google-play
                name: deliver_malte_android
                production_delivery: false
                requires:
                    - check
                    - e2e_android
                    - build_malte_android
            - build_android:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_aschaffenburg_android
                requires:
                    - bump_version
            - deliver_android:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-google-play
                name: deliver_aschaffenburg_android
                production_delivery: false
                requires:
                    - check
                    - e2e_android
                    - build_aschaffenburg_android
            - sentry_android:
                context:
                    - mattermost
                    - sentry
                requires:
                    - build_integreat_android
                    - build_malte_android
                    - build_aschaffenburg_android
            - notify_android:
                context:
                    - mattermost
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_integreat_android
                    - deliver_malte_android
                    - deliver_aschaffenburg_android
            - build_ios:
                build_config_name: integreat-e2e
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_e2e_ios
                requires:
                    - bump_version
            - e2e_ios:
                context:
                    - mattermost
                    - browserstack
                requires:
                    - build_e2e_ios
            - build_ios:
                build_config_name: integreat
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_integreat_ios
                requires:
                    - bump_version
            - deliver_ios:
                build_config_name: integreat
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-apple
                name: deliver_integreat_ios
                production_delivery: false
                requires:
                    - check
                    - e2e_ios
                    - build_integreat_ios
            - build_ios:
                build_config_name: malte
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_malte_ios
                requires:
                    - bump_version
            - deliver_ios:
                build_config_name: malte
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-apple
                    - fastlane-match
                name: deliver_malte_ios
                production_delivery: false
                requires:
                    - check
                    - e2e_ios
                    - build_malte_ios
            - build_ios:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_aschaffenburg_ios
                requires:
                    - bump_version
            - deliver_ios:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-apple
                name: deliver_aschaffenburg_ios
                production_delivery: false
                requires:
                    - check
                    - e2e_ios
                    - build_aschaffenburg_ios
            - sentry_ios:
                context:
                    - mattermost
                    - sentry
                requires:
                    - build_integreat_ios
                    - build_malte_ios
                    - build_aschaffenburg_ios
            - notify_ios:
                context:
                    - mattermost
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_integreat_ios
                    - deliver_malte_ios
                    - deliver_aschaffenburg_ios
        when:
            and:
                - << pipeline.parameters.api_triggered >>
                - equal:
                    - << pipeline.parameters.workflow_type >>
                    - native_beta_delivery
    native_production_delivery:
        jobs:
            - bump_version:
                context:
                    - mattermost
                    - deliverino
                prepare_delivery: true
            - check:
                context:
                    - codeclimate-integreat-app
                    - mattermost
            - build_android:
                build_config_name: integreat-e2e
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_e2e_android
                requires:
                    - bump_version
            - e2e_android:
                context:
                    - mattermost
                    - browserstack
                requires:
                    - build_e2e_android
            - build_android:
                build_config_name: integreat
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_integreat_android
                requires:
                    - bump_version
            - deliver_android:
                build_config_name: integreat
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-google-play
                name: deliver_integreat_android
                production_delivery: true
                requires:
                    - check
                    - e2e_android
                    - build_integreat_android
            - build_android:
                build_config_name: malte
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_malte_android
                requires:
                    - bump_version
            - deliver_android:
                build_config_name: malte
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-google-play
                name: deliver_malte_android
                production_delivery: true
                requires:
                    - check
                    - e2e_android
                    - build_malte_android
            - build_android:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - credentials-repo
                    - credentials-integreat
                name: build_aschaffenburg_android
                requires:
                    - bump_version
            - deliver_android:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-google-play
                name: deliver_aschaffenburg_android
                production_delivery: true
                requires:
                    - check
                    - e2e_android
                    - build_aschaffenburg_android
            - sentry_android:
                context:
                    - mattermost
                    - sentry
                requires:
                    - build_integreat_android
                    - build_malte_android
                    - build_aschaffenburg_android
            - notify_android:
                context:
                    - mattermost
                    - deliverino
                production_delivery: true
                requires:
                    - deliver_integreat_android
                    - deliver_malte_android
                    - deliver_aschaffenburg_android
            - build_ios:
                build_config_name: integreat-e2e
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_e2e_ios
                requires:
                    - bump_version
            - e2e_ios:
                context:
                    - mattermost
                    - browserstack
                requires:
                    - build_e2e_ios
            - build_ios:
                build_config_name: integreat
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_integreat_ios
                requires:
                    - bump_version
            - deliver_ios:
                build_config_name: integreat
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-apple
                name: deliver_integreat_ios
                production_delivery: true
                requires:
                    - check
                    - e2e_ios
                    - build_integreat_ios
            - build_ios:
                build_config_name: malte
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_malte_ios
                requires:
                    - bump_version
            - deliver_ios:
                build_config_name: malte
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-apple
                name: deliver_malte_ios
                production_delivery: true
                requires:
                    - check
                    - e2e_ios
                    - build_malte_ios
            - build_ios:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - tuerantuer-apple
                    - fastlane-match
                name: build_aschaffenburg_ios
                requires:
                    - bump_version
            - deliver_ios:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - browserstack
                    - tuerantuer-apple
                name: deliver_aschaffenburg_ios
                production_delivery: true
                requires:
                    - check
                    - e2e_ios
                    - build_aschaffenburg_ios
            - sentry_ios:
                context:
                    - mattermost
                    - sentry
                requires:
                    - build_integreat_ios
                    - build_malte_ios
                    - build_aschaffenburg_ios
            - notify_ios:
                context:
                    - mattermost
                    - deliverino
                production_delivery: true
                requires:
                    - deliver_integreat_ios
                    - deliver_malte_ios
                    - deliver_aschaffenburg_ios
        when:
            and:
                - << pipeline.parameters.api_triggered >>
                - equal:
                    - << pipeline.parameters.workflow_type >>
                    - native_production_delivery
    native_promotion:
        jobs:
            - promote_android:
                build_config_name: integreat
                context:
                    - mattermost
                    - tuerantuer-google-play
                    - deliverino
                name: promote_integreat_android
            - promote_android:
                build_config_name: malte
                context:
                    - mattermost
                    - tuerantuer-google-play
                    - deliverino
                name: promote_malte_android
            - promote_android:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - tuerantuer-google-play
                    - deliverino
                name: promote_aschaffenburg_android
            - promote_ios:
                build_config_name: integreat
                context:
                    - mattermost
                    - tuerantuer-apple
                    - deliverino
                name: promote_integreat_ios
            - promote_ios:
                build_config_name: malte
                context:
                    - mattermost
                    - tuerantuer-apple
                    - deliverino
                name: promote_malte_ios
            - promote_ios:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                    - tuerantuer-apple
                    - deliverino
                name: promote_aschaffenburg_ios
        when:
            and:
                - << pipeline.parameters.api_triggered >>
                - equal:
                    - << pipeline.parameters.workflow_type >>
                    - native_promotion
    version: 2
    web_beta_delivery:
        jobs:
            - bump_version:
                context:
                    - mattermost
                    - deliverino
                prepare_delivery: true
            - check:
                context:
                    - codeclimate-integreat-app
                    - mattermost
            - e2e_web:
                context:
                    - mattermost
                requires:
                    - bump_version
            - build_web:
                build_config_name: integreat
                context:
                    - mattermost
                name: build_integreat_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: malte
                context:
                    - mattermost
                name: build_malte_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                name: build_aschaffenburg_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: obdach
                context:
                    - mattermost
                name: build_obdach_web
                requires:
                    - bump_version
            - deliver_web:
                context:
                    - mattermost
                delivery: beta
                requires:
                    - check
                    - e2e_web
                    - build_integreat_web
                    - build_malte_web
                    - build_aschaffenburg_web
                    - build_obdach_web
            - sentry_web:
                context:
                    - mattermost
                    - sentry
                requires:
                    - build_integreat_web
                    - build_malte_web
                    - build_aschaffenburg_web
                    - build_obdach_web
            - notify_web:
                context:
                    - mattermost
                    - deliverino
                production_delivery: false
                requires:
                    - deliver_web
        when:
            and:
                - << pipeline.parameters.api_triggered >>
                - equal:
                    - << pipeline.parameters.workflow_type >>
                    - web_beta_delivery
    web_production_delivery:
        jobs:
            - bump_version:
                context:
                    - mattermost
                    - deliverino
                prepare_delivery: true
            - check:
                context:
                    - codeclimate-integreat-app
                    - mattermost
            - e2e_web:
                context:
                    - mattermost
                requires:
                    - bump_version
            - build_web:
                build_config_name: integreat
                context:
                    - mattermost
                name: build_integreat_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: malte
                context:
                    - mattermost
                name: build_malte_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: aschaffenburg
                context:
                    - mattermost
                name: build_aschaffenburg_web
                requires:
                    - bump_version
            - build_web:
                build_config_name: obdach
                context:
                    - mattermost
                name: build_obdach_web
                requires:
                    - bump_version
            - deliver_web:
                context:
                    - mattermost
                delivery: production
                requires:
                    - check
                    - e2e_web
                    - build_integreat_web
                    - build_malte_web
                    - build_aschaffenburg_web
                    - build_obdach_web
            - sentry_web:
                context:
                    - mattermost
                    - sentry
                requires:
                    - build_integreat_web
                    - build_malte_web
                    - build_aschaffenburg_web
                    - build_obdach_web
            - notify_web:
                context:
                    - mattermost
                    - deliverino
                production_delivery: true
                requires:
                    - deliver_web
        when:
            and:
                - << pipeline.parameters.api_triggered >>
                - equal:
                    - << pipeline.parameters.workflow_type >>
                    - web_production_delivery
    web_promotion:
        jobs:
            - promote_web:
                context:
                    - mattermost
                    - deliverino
        when:
            and:
                - << pipeline.parameters.api_triggered >>
                - equal:
                    - << pipeline.parameters.workflow_type >>
                    - web_promotion

