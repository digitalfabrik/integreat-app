docker:
  - image: circleci/node:12.16.3
resource_class: small
environment:
  TOTAL_CPUS: 1 # For resource_class small
shell: /bin/bash -eo pipefail
steps:
  - checkout
  - check_config
  - restore_cache:
      name: Restore Yarn Package Cache
      keys: # Integer Prefix used for manually invalidating caches by incrementing.
        - 6-yarn-{{ arch }}-{{ checksum "yarn.lock" }}-{{ checksum "package.json" }}
  - run:
      name: Install Dependencies
      command: yarn install --frozen-lockfile
  - save_cache:
      name: Save Yarn Package Cache
      key: 6-yarn-{{ arch }}-{{ checksum "yarn.lock" }}-{{ checksum "package.json" }}
      paths:
        - ~/.cache/yarn
        - node_modules
        - native/node_modules
        - web/node_modules
  - run:
      name: Linting check
      command: yarn workspace native lint
  - run:
      name: Flow-type check
      command: yarn workspace native flow:check-now --max-workers ${TOTAL_CPUS}
  - run:
      name: Unit tests
      command: yarn workspace native test --maxWorkers ${TOTAL_CPUS}
  - notify_failed
