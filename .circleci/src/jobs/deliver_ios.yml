# Deliver the app to the Apple App Store or Testflight.
parameters:
  build_config_name:
    type: enum
    enum: [integreat, malte, aschaffenburg]
    default: integreat
  production_delivery:
    description: Whether to deliver the build to production.
    type: boolean
macos:
  xcode: 16.3.0
environment:
  FASTLANE_SKIP_UPDATE_CHECK: true
shell: /bin/bash --login -o pipefail
steps:
  - checkout
  - prepare_workspace
  - restore_environment_variables
  - restore_yarn_cache
  - restore_ruby_cache:
      directory: native
  - restore_ruby_cache:
      directory: native/ios
  - run:
      name: Prepare App Store metadata
      command: yarn app-toolbelt v0 release-notes prepare-metadata << parameters.build_config_name >> appstore ../native/ios/fastlane/<< parameters.build_config_name >>/metadata
      working_directory: native
  - when:
      condition: << parameters.production_delivery >>
      steps:
        - run:
            name: '[FL] Apple AppStoreConnect Upload'
            command: bundle exec fastlane ios appstoreconnect_upload ipa_path:attached_workspace/<< parameters.build_config_name >>.ipa version_name:${NEW_VERSION_NAME} build_config_name:<< parameters.build_config_name >>
            working_directory: native/ios
  - unless:
      condition: << parameters.production_delivery >>
      steps:
        - run:
            name: '[FL] Apple TestFlight Upload'
            command: bundle exec fastlane ios testflight_upload build_config_name:<< parameters.build_config_name >> ipa_path:attached_workspace/<< parameters.build_config_name >>.ipa
            working_directory: native/ios
  - run:
      name: '[FL] Browserstack Upload Live'
      command: bundle exec fastlane browserstack_upload path:attached_workspace/<< parameters.build_config_name >>.ipa
      working_directory: native
  - run:
      name: Upload Source Maps to Sentry
      command: |
        tools/sentry-release de.integreat-app "${NEW_VERSION_NAME}" ~/attached_workspace/sourcemaps/integreat --version-code "${NEW_VERSION_CODE}"
        tools/sentry-release de.malteapp "${NEW_VERSION_NAME}" ~/attached_workspace/sourcemaps/malte --version-code "${NEW_VERSION_CODE}"
        tools/sentry-release app.aschaffenburg "${NEW_VERSION_NAME}" ~/attached_workspace/sourcemaps/aschaffenburg --version-code "${NEW_VERSION_CODE}"
  - notify
