unless: << pipeline.parameters.api_triggered >>
jobs:
  - bump_version:
      context:
        - mattermost
      delivery: none

  - build_web:
      name: build_ig_test_cms_web
      build_config_name: integreat-test-cms
      context:
        - mattermost
      requires:
        - bump_version

  # On feature branches: Execute checks and e2e tests

  - check:
      filters:
        branches:
          ignore:
            - main
      context:
        - mattermost
  - e2e_web:
      filters:
        branches:
          ignore:
            - main
      context:
        - mattermost
      requires:
        - bump_version
        - check

  - build_android:
      filters:
        branches:
          ignore:
            - main
      name: build_e2e_android
      build_config_name: integreat-e2e
      context:
        - mattermost
        - tuerantuer-google-play
        - tuerantuer-android
      requires:
        - bump_version
        - check
  - e2e_android:
      filters:
        branches:
          ignore:
            - main
      context:
        - mattermost
        - browserstack
      requires:
        - build_e2e_android

  - build_ios:
      filters:
        branches:
          ignore:
            - main
      name: build_e2e_ios
      build_config_name: integreat-e2e
      context:
        - mattermost
        - tuerantuer-apple
        - tuerantuer-ios
      requires:
        - bump_version
        - check
  - e2e_ios:
      filters:
        branches:
          ignore:
            - main
      context:
        - mattermost
        - browserstack
      requires:
        - build_e2e_ios

  # On main branch: Deliver web to webnext and upload apk and ipa to browserstack

  - build_web:
      filters:
        branches:
          only:
            - main
      name: build_malte_web
      build_config_name: malte
      context:
        - mattermost
      requires:
        - bump_version
  - build_web:
      filters:
        branches:
          only:
            - main
      name: build_aschaffenburg_web
      build_config_name: aschaffenburg
      context:
        - mattermost
      requires:
        - bump_version
  - deliver_web:
      filters:
        branches:
          only:
            - main
      context:
        - mattermost
        - sentry
      production_delivery: false
      requires:
        - build_ig_test_cms_web
        - build_malte_web
        - build_aschaffenburg_web

  - build_android:
      filters:
        branches:
          only:
            - main
      name: build_ig_test_cms_android
      build_config_name: integreat-test-cms
      context:
        - mattermost
        - tuerantuer-google-play
        - tuerantuer-android
      requires:
        - bump_version
  - upload_browserstack:
      filters:
        branches:
          only:
            - main
      name: upload_ig_test_cms_android_browserstack
      artifact_name: integreat-test-cms.apk
      context:
        - mattermost
        - browserstack
      requires:
        - build_ig_test_cms_android

  - build_ios:
      filters:
        branches:
          only:
            - main
      name: build_ig_test_cms_ios
      build_config_name: integreat-test-cms
      context:
        - mattermost
        - tuerantuer-apple
        - tuerantuer-ios
      requires:
        - bump_version
  - upload_browserstack:
      filters:
        branches:
          only:
            - main
      name: upload_ig_test_cms_ios_browserstack
      artifact_name: integreat-test-cms.ipa
      context:
        - mattermost
        - browserstack
      requires:
        - build_ig_test_cms_ios
