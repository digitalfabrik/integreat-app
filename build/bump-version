#!/usr/bin/env node

const authenticate = require('./github-authentication')
const { program } = require('commander')

const VERSION_FILE = 'version.json'

program
  .option('-d, --debug', 'enable extreme logging')
  .requiredOption('--deliverino-private-key <deliverino-private-key>', 'private key of the deliverino github app in pem format with base64 encoding')
  .requiredOption('--owner <owner>', 'owner of the current repository, usually "Integreat"')
  .requiredOption('--repo <repo>', 'the current repository, usually "integreat-webapp" or "integreat-react-native-app"')
  .requiredOption('--branch <branch>', 'the current branch')

const commitAndTag = async (newVersionName, newVersionCode, { deliverinoPrivateKey, owner, repo, branch }) => {
  const appOctokit = await authenticate({ deliverinoPrivateKey, owner, repo })
  const versionFileContent = await appOctokit.repos.getContents({ owner, repo, path: VERSION_FILE, ref: branch })

  const contentBase64 = Buffer.from(JSON.stringify({ newVersionName, newVersionCode })).toString('base64')

  const message = newVersionCode
    ? `Bump version name to ${newVersionName} and version code to ${newVersionCode}\n[skip ci]`
    : `Bump version name to ${newVersionName}\n[skip ci]`

  const commit = await appOctokit.repos.createOrUpdateFile({
    owner,
    repo,
    path: VERSION_FILE,
    content: contentBase64,
    branch,
    message,
    sha: versionFileContent.data.sha
  })
  console.warn(`New version successfully commited with message "${message}"`)
  console.warn(commit)

  const commitSha = commit.data.commit.sha

  const tag = `${newVersionName}${newVersionCode ? ` (version code: ${newVersionCode})` : ''}`
  const tagMessage = `Release ${tag}. Release notes can be found in 'release-notes/${newVersionName}`

  const test = await appOctokit.git.createTag({
    owner,
    repo,
    tag,
    message: tagMessage,
    object: commitSha,
    type: 'commit'
  })
  console.warn(test)
}

program
  .command('bump_to <new-version-name> [new-version-code]')
  .description('commits the supplied version name and code to github and tags the commit')
  .action(async (newVersionName, newVersionCode) => {
    try {
      const newVersion = JSON.stringify({ newVersionName, newVersionCode })
      await commitAndTag(newVersion, { ...program })
    } catch (e) {
      console.error(e)
      process.exit(1)
    }
  })

program.parse(process.argv)
