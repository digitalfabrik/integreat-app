fastlane_version "2.67.0"

default_platform :ios

build_number = 100008
output_name = "Integreat-#{build_number}.ipa"

platform :ios do
  before_all do
    setup_circle_ci
  end

  desc "Setup certificates"
  lane :certificates do
    sync_code_signing(type: "appstore", app_identifier: ["de.integreat-app"])
  end

  desc "Create a simulator build"
  lane :build do
    xcbuild(
        workspace: "Integreat.xcworkspace",
        scheme: "Integreat",
        configuration: "Debug",
        xcargs: "-sdk iphonesimulator"
    )

    # scan(
    #     workspace: "Integreat.xcworkspace",
    #     scheme: "Integreat",
    #     configuration: "Debug",
    #     build_for_testing: true
    # )
  end

  desc "Create a simulator build"
  lane :release do
    sync_code_signing(type: "app-store", app_identifier: ["de.integreat-app"])

    increment_build_number(
        build_number: build_number
    )

    increment_version_number(
        version_number: "2020.3.2"
    )

    build_app(
        workspace: "Integreat.xcworkspace",
        scheme: "Integreat",
        output_name: output_name,
        export_method: "app-store",
        include_bitcode: true
    )
  end

  desc "Upload to Browserstack"
  lane :browserstack_upload do
    upload_to_browserstack_app_live(
        browserstack_username: ENV["BROWSERSTACK_USERNAME"],
        browserstack_access_key: ENV["BROWSERSTACK_ACCESS_KEY"],
        file_path: "output/gym/#{output_name}"
    )
  end

  after_all do |lane|
  end

  error do |lane, exception|
  end
end
