require_relative '../../fastlane/version'

fastlane_version "2.143.0"

output_name = "Integreat.ipa"

before_all do
  setup_circle_ci
end

desc "Setup certificates"
lane :certificates do
  sync_code_signing(type: "appstore", app_identifier: ["de.integreat-app"])
end

desc "Create a simulator build"
lane :build do
  xcbuild(
      workspace: "Integreat.xcworkspace",
      scheme: "Integreat",
      configuration: "Debug",
      xcargs: "-sdk iphonesimulator"
  )
end

desc "Create a release build"
lane :release do
  ENV["E2E_TEST_IDS"] = "1"
  ENV["BUNDLE_CONFIG"] = "./metro.config.ci.js"

  next_version = next_version()

  sync_code_signing(type: "development", app_identifier: ["de.integreat-app"])
  sync_code_signing(type: "appstore", app_identifier: ["de.integreat-app"])

  increment_build_number(
      build_number: next_version[:new_version_code]
  )

  increment_version_number(
      version_number: next_version[:new_version_name]
  )

  build_app(
      workspace: "Integreat.xcworkspace",
      scheme: "Integreat",
      output_name: output_name,
      export_method: "app-store",
      include_bitcode: false # Uploading to BrowserStack does not work when including Bitcode
  )
end

desc "Upload to TestFlight"
lane :testflight_upload do
  ensure_env_vars(
      env_vars: ['FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD']
  )

  # https://docs.fastlane.tools/actions/deliver/
  deliver(
      ipa: "output/gym/#{output_name}",
      submit_for_review: false,
      automatic_release: false,
      force: true,
      metadata_path: "./metadata"
  )
end
